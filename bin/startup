#!/usr/bin/env node

const CronJob = require('cron').CronJob

const registerOrRenewCert = require('../lib/register-or-renew-cert')

const certbotArgs = process.argv.slice(2)
const {DOMAINS, EMAIL, AUTO, CRON_PATTERN, DEVELOPMENT} = process.env

const auto = process.env.AUTO === 'false' ? false : true
const development = DEVELOPMENT === 'true' ? true : false
const defaultCronPattern = '00 00 00 * * *' // every day at midnight
const port = 13135

if (!DOMAINS || !DOMAINS.length) {
  throw new Error('No domains given.')
}

if (!EMAIL) {
  throw new Error('No email given.')
}

const domains = DOMAINS.split(',').map(v => v.trim())

const registerOrRenew = () => registerOrRenewCert({
  port,
  staticDir: '/var/www',
  domains,
  email: EMAIL,
  development,
  certbotArgs
})
  .then(result => console.log(result))
  .catch(err   => console.log(err) && process.exit(1))

registerOrRenew().then(() => {
  if (auto) {
    const job = new CronJob(CRON_PATTERN || defaultCronPattern, registerOrRenew)
    job.start()
  }
})
